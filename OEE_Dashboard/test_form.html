<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>OEE API Test Form</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
        <link rel="stylesheet" href="style/style.css">
    </head>

    <body>
        <div class="Header">
            <div class="OEE-head">
                <h1>Overall Equipment Effectiveness</h1>
                <h2>Assembly Line</h2>
                <p id="datetime"></p>
            </div>
            <div class="assis-tool">
            </div>
        </div>

        <div class="oee-piechart">
            <div style="display: block;width: 100%">
                <div class="pie-chart">
                    <fieldset>
                        <h3>OEE</h3>
                        <div class="piechart-wrapper">
                            <canvas id="oeePieChart"></canvas>
                            <div class="error-message" id="oeeError">⚠️</div>
                        </div>
                    </fieldset>
                    <fieldset>
                        <h3>Quality</h3>
                        <div class="piechart-wrapper">
                            <canvas id="qualityPieChart"></canvas>
                            <div class="error-message" id="qualityError">⚠️</div>
                        </div>
                    </fieldset>
                    <fieldset>
                        <h3>Performance</h3>
                        <div class="piechart-wrapper">
                            <canvas id="performancePieChart"></canvas>
                            <div class="error-message" id="performanceError">⚠️</div>
                        </div>
                    </fieldset>
                    <fieldset>
                        <h3>Availability</h3>
                        <div class="piechart-wrapper">
                            <canvas id="availabilityPieChart"></canvas>
                            <div class="error-message" id="availabilityError">⚠️</div>
                        </div>
                    </fieldset>
                </div>
            </div>

            <div class="add-data">
                <button>OEE</button><br>
                <button onclick="openModal('partModal')">Part</button><br>
                <button onclick="openModal('scrapModal')">Scrap</button><br>
                <button onclick="openModal('stopModal')">Stop Cause</button><br>
                <p>Last update: <span id="last-update">--</span></p>
            </div>
        </div>

        <div class="oee-linechart">
            <div style="display: block;width: 100%">
                <div class="line-chart">
                    <fieldset>
                        <h3>OEE</h3>
                        <div class="linechart-wrapper">
                            <canvas id="oeeLineChart"></canvas>
                        </div>
                        <div id="oeeLineError" class="chart-error">Can't fetch data</div>
                    </fieldset>
                    <fieldset>
                        <h3>Quality</h3>
                        <div class="linechart-wrapper">
                            <canvas id="qualityLineChart"></canvas>
                        </div>
                        <div id="oeeLineError" class="chart-error">Can't fetch data</div>
                    </fieldset>
                    <fieldset>
                        <h3>Performance</h3>
                        <div class="linechart-wrapper">
                            <canvas id="performanceLineChart"></canvas>
                        </div>
                        <div id="oeeLineError" class="chart-error">Can't fetch data</div>
                    </fieldset>
                    <fieldset>
                        <h3>Availability</h3>
                        <div class="linechart-wrapper">
                            <canvas id="availabilityLineChart"></canvas>
                        </div>
                        <div id="oeeLineError" class="chart-error">Can't fetch data</div>
                    </fieldset>
                </div>
            </div>

            <div class="dowload-data">
                <button onclick="exportToPDF()">Export to PDF</button>
                <button onclick="exportToCSV()">Export to Excel</button>
            </div>
        </div>

        <div class="stop_scarp-barchart">
            <div style="display: block;width: 100%">
                <div class="bar-chart">
                    <div style="position: relative; width: 100%; height: 100%;">
                        <canvas id="scrapBarChart"></canvas>
                        <div id="scrapBarError" style="display: none; position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); color: red; font-size: 20px; font-weight: bold; z-index: 10;">Error loading scrap data</div>
                    </div>
                    <div style="position: relative; width: 100%; height: 100%;">
                        <canvas id="stopCauseBarChart"></canvas>
                        <div id="stopCauseBarError" style="display: none; position: absolute; top: 45%; left: 50%; transform: translate(-50%, -50%); color: red; font-size: 20px; font-weight: bold; z-index: 10;">Error loading stop cause data</div>
                    </div>
                </div>
            </div>
            <div class="add-filters">
                <!--<div class="filters">
                    <label for="line"></label>
                    <select id="line">
                        <option value="">Line</option>
                        <option value="ALL">All</option>
                        <option value="Line A">Line A</option>
                        <option value="Line B">Line B</option>                     
                    </select>
                    <label for="machine"></label>
                    <select id="machine">
                        <option value="">Machine</option>
                        <option value="All">All</option>
                        <option value="Machine 1">Machine 1</option>
                        <option value="Machine 2">Machine 2</option>                   
                    </select>
                </div>-->
                <div class="date-filter">
                    <label for="startDate"></label>
                    <input type="date" id="startDate" />

                    <label for="endDate"></label>
                    <input type="date" id="endDate" />

                    <label for="shift"></label>
                    <select id="shift">
                        <option value="">Shift</option>
                        <option value="All">All</option>
                        <option value="1">Shift 1</option>
                        <option value="2">Shift 2</option>
                        <option value="3">Shift 3</option>
                    </select>

                    <button onclick="fetchBarCharts()">Filter</button>
                </div>
            </div>
        </div>
        <!-- Modal background and form for Part -->
        <div id="partModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('partModal')">&times;</span>
                <h2>Add Part</h2>
                <form action="api/add_part.php" method="POST">
                    <input type="date" name="log_date" required value="<?= date('Y-m-d') ?>"><br>
                    <input type="time" placeholder="Time" name="log_time" required value="<?= date('H:i') ?>"><br>
                    <!--<input type="date" name="log_date" required><br>
                    <input type="text" placeholder="Shilf" name="shift" required><br>
                    <input type="time" placeholder="Time" name="log_time" required><br>-->
                    <input type="text" placeholder="Part No." name="part_no" required><br>
                    <select name="count_type" required>
                        <option value="">-- Select Type --</option>
                        <option value="fg_count">FG Count</option>
                        <option value="ng_count">NG Count</option>
                        <option value="rework_count">Rework</option>
                        <option value="hold_count">Hold</option>
                    </select>
                    <input type="number" name="count_value" placeholder="Enter value" required>
                    <button type="submit">Submit Part</button>
                </form>
            </div>
        </div>

        <!-- Modal for Scrap -->
        <div id="scrapModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('scrapModal')">&times;</span>
                <h2>Add Scrap</h2>
                <form action="api/add_scrap.php" method="POST">
                    <input type="date" name="log_date" required><br>
                    <input type="text" placeholder="Shift" name="shift" required><br>
                    <input type="time" placeholder="Time" name="log_time" required><br>
                    <input type="text" placeholder="Part No" name="part_no" required><br>
                    <input type="number" placeholder="Scrap Count" name="scrap_count"><br>
                    <button type="submit">Submit Scrap</button>
                </form>
            </div>
        </div>

        <!-- Modal for Stop Cause -->
        <div id="stopModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal('stopModal')">&times;</span>
                <h2>Add Stop Cause</h2>
                <form action="api/add_stop.php" method="POST">
                    <input type="date" name="log_date" required><br>
                    <input type="text" placeholder="Shift" name="shift" required><br>
                    <input type="time" placeholder="Time" name="log_time" required><br>
                    <input type="text" placeholder="Cause" name="stop_cause" required><br>
                    <input type="number" placeholder="Stop Time (min)" name="stop_time"><br>
                    <input type="text" placeholder="Note" name="note"><br>
                    <button type="submit">Submit Stop Cause</button>
                </form>
            </div>
        </div>

        <script>
            window.addEventListener('DOMContentLoaded', () => {
                const now = new Date();

                // Format date as yyyy-mm-dd
                const dateStr = now.toISOString().split('T')[0];

                // Format time as hh:mm
                const timeStr = now.toTimeString().split(':').slice(0, 2).join(':');

                // Set default values for all date and time inputs
                document.querySelectorAll('input[type="date"]').forEach(input => input.value = dateStr);
                document.querySelectorAll('input[type="time"]').forEach(input => input.value = timeStr);
            });
        </script>

        <script>
            function openModal(id) {
                document.getElementById(id).style.display = 'block';
            }

            function closeModal(id) {
                document.getElementById(id).style.display = 'none';
            }

            // Optional: close modal if clicking outside the content
            window.onclick = function (event) {
                document.querySelectorAll('.modal').forEach(modal => {
                    if (event.target === modal) {
                        modal.style.display = "none";
                    }
                });
            }
        </script>

        <script src="script/datetime.js"></script>
        <script src="script/export_data.js"></script>
        <script src="script/auto_updateDB.js"></script>
        <script src="script/fetch_line&barchart.js"></script>
        <script src="script/fetch_piechart.js"></script>
        <script src="script/OEE_piechart.js"></script>
        <script src="script/OEE_linechart.js"></script>
        <script src="script/OEE_barchart.js"></script>
    </body>

</html>
